name: Continuous Integration

on:
  pull_request:
    branches:
      - main

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install cargo-binstall command
        uses: cargo-bins/cargo-binstall@main

      - name: Set up toolchain
        uses: moonrepo/setup-toolchain@v0
        with:
          auto-install: true

      - run: moon ci --color --log debug
        env:
          RUST_LOG: ${{ vars.RUST_LOG }}
          SUBSCRIPTIONS__APPLICATION__PORT: ${{ vars.SUBSCRIPTIONS__APPLICATION__PORT }}
          SUBSCRIPTIONS__APPLICATION__HOST: ${{ vars.SUBSCRIPTIONS__APPLICATION__HOST }}
          SUBSCRIPTIONS__DATABASE__URL: ${{ vars.SUBSCRIPTIONS__DATABASE__URL }}
          SUBSCRIPTIONS__DATABASE__USERNAME: ${{ vars.SUBSCRIPTIONS__DATABASE__USERNAME }}
          SUBSCRIPTIONS__DATABASE__PASSWORD: ${{ secrets.SUBSCRIPTIONS__DATABASE__PASSWORD }}
          SUBSCRIPTIONS__DATABASE__NAMESPACE: ${{ vars.SUBSCRIPTIONS__DATABASE__NAMESPACE }}
          SUBSCRIPTIONS__DATABASE__NAME: ${{ vars.SUBSCRIPTIONS__DATABASE__NAME }}

      - name: Run report
        uses: moonrepo/run-report-action@v1
        if: success() || failure()
        with:
          access-token: ${{ secrets.GITHUB_TOKEN }}
